"use strict";angular.module("assetFormApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angular-loading-bar","cfp.loadingBar"]),angular.module("assetFormApp").directive("loginForm",["login",function(a){return{restrict:"E",templateUrl:"scripts/loginForm/loginForm.html",controller:["$scope","login",function(a,b){a.token="",a.loggedIn=!0,a.login=function(c,d){b.login(c,d).then(function(b){b.token?(a.token=b.token,a.loggedIn=b.token,a.modal.modal("hide")):b.error&&(a.loggedIn=!1,a.message=b.error.details)})}}],link:function(a,b,c){a.modal=$("#loginModal",b[0]),a.modal.modal({keyboard:!1,backdrop:"static"})}}}]).factory("login",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"POST",url:"https://maps.raleighnc.gov/portal/sharing/generateToken",data:$.param({request:"getToken",username:c,password:d,expiration:60,referer:document.baseURI,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e.resolve).error(e.resolve),e.promise}var d={login:c};return d}]),angular.module("assetFormApp").directive("assetForm",["assets","login",function(a,b){return{require:"^?loginForm",restrict:"E",templateUrl:"scripts/assetForm/assetForm.html",controller:["$scope","$timeout","$window","login",function(b,c,d,e){b.exists=!1,b.toggleGrayout=function(a){a?b.grayout=a:c(function(){b.grayout=a},500)};var f=function(a,c){b.alert={type:a,message:c},d.scrollTo(0,0)},g=function(){var a="",c=b.fields.filter(function(a){return"ASSET_TAG"===a.name});return c.length>0&&(c=c[0],a=c.value),a},h=function(c){a.getSites(c).then(function(a){b.sites=[];var c=[];angular.forEach(a.features,function(a){if(-1===c.indexOf(a.attributes.SITE))b.sites.push({name:a.attributes.SITE,id:parseInt(a.attributes.FACILITYID),buildings:[{name:a.attributes.LOCATION,id:parseInt(a.attributes.FACILITYID),address:a.attributes.LEGACYID}]}),c.push(a.attributes.SITE);else{var d=b.sites.filter(function(b){return b.name===a.attributes.SITE});d.length>0&&(d=d[0],d.buildings.push({name:a.attributes.LOCATION,id:parseInt(a.attributes.FACILITYID),address:a.attributes.LEGACYID,assetType:a.attributes.ASSET_TYPE,assetId:a.attributes.ASSET_TYPE_FACILITYID}))}})})},i=function(c,d){b.toggleGrayout(!0),a.getTypes(b.token,d).then(function(a,c,f){b.toggleGrayout(!1),a.error?498===a.error.code&&e.login(b.user,b.password).then(function(a){b.token=a.token,i(a.token,d)}):(""===a&&b.showMessage("danger","Could not complete request, check internet connectivity!"),b.tableData=a,b.fields=a.fields,b.prefix=a.description,b.types=a.types)},function(a,c){b.toggleGrayout(!1)})},j=function(c,d,h){b.toggleGrayout(!0),a.checkAssetExists(c,d.value,h).then(function(a){b.toggleGrayout(!1),console.log(a),a.error?498===a.error.code&&e.login(b.user,b.password).then(function(a){b.token=a.token,j(b.token,d,b.table.id)}):a.features.length>0?(b.oid=a.features[0].attributes.OBJECTID,k(a.features[0].attributes),f("warning","An asset with a tag of "+b.prefix+" - "+g()+" has already been entered. Any changes will update the existing asset."),b.exists=!0):(""===a&&b.showMessage("danger","Could not complete request, check internet connectivity!"),b.exists&&b.clearForm(!1,!0),f("info","An asset with a tag of "+b.prefix+" - "+g()+" has not been entered. Fill out the form and click submit to enter asset."),b.exists=!1)},function(a,c){b.toggleGrayout(!1)})},k=function(a){var c=b.sites.filter(function(b){return b.name===a.SITE});c.length>0&&(c=c[0],b.site=c,b.buildings=c.buildings);var d=b.types.filter(function(b){return b.id===a.ASSET_TYPE_SUBTYPE});d.length>0&&(d=d[0],b.type=d),angular.forEach(b.fields,function(d){switch(d.name){case"SITE":d.value=c;break;case"LOCATION":var e=b.buildings.filter(function(b){return b.name===a.LOCATION});e.length>0&&(e=e[0],d.value=e,b.building=e);break;default:d.value=a[d.name],"esriFieldTypeDate"===d.type&&d.value?d.value=moment(d.value).zone(-5).format("MM/DD/YYYY"):d.domain||"string"!=typeof d.value||(d.value=d.value.toUpperCase())}})},l=function(c,d,h,i){b.processing=!0,b.toggleGrayout(!0),a.submitAsset(c,d,h,i).then(function(a){b.processing=!1,b.toggleGrayout(!1),console.log(a);var c=!1;a.error?498===a.error.code&&e.login(b.user,b.password).then(function(a){b.token=a.token,l(a.token,d,h,i)}):(a.addResults?c=a.addResults[0].success:a.updateResults&&(c=a.updateResults[0].success),c?(f("success","An asset with a type of "+b.type.name+" and a tag of "+b.prefix+" - "+g()+" successfully "+(a.updateResults?"updated":"created")+"."),b.oid=null,b.clearForm(!1,!1),b.exists=!1):f("danger","Error submitting assets, please check internet connectivity and try again"))})};b.$watch("token",function(c){c&&!b.tables&&(b.toggleGrayout(!0),a.getTables(c).then(function(a){b.toggleGrayout(!1),b.tables=a.tables,h(c)},function(a,c){b.toggleGrayout(!1)}))}),b.$watch("type",function(a){a&&b.typeSelected(a)}),b.tableSelected=function(a){b.alert=null,b.oid=null,b.type=null,b.types=null,b.fields=[],ga("send","event","Table","Table Selected",b.table.name),i(b.token,a)},b.typeSelected=function(a){ga("send","event","Type","Type Selected",b.type.name),angular.forEach(b.tableData.fields,function(b){a.domains[b.name]?a.domains[b.name].codedValues&&(b.domain=a.domains[b.name]):b.domain=null,a.templates[0].prototype.attributes[b.name]&&" "!=a.templates[0].prototype.attributes[b.name]&&(b.value=a.templates[0].prototype.attributes[b.name],b.defaultValue=b.value)}),b.fields=b.tableData.fields},b.siteSelected=function(){var a=b.fields.filter(function(a){return"SITE"===a.name||"LOCATION"===a.name});a.length>0&&angular.forEach(a,function(a){"SITE"===a.name?(b.site=a.value,ga("send","event","Site","Site Selected",b.site.name),b.buildings=a.value.buildings):"LOCATION"===a.name&&(a.value=void 0)})},b.bldgSelected=function(){var a=b.fields.filter(function(a){return"LOCATION"===a.name});a.length>0&&(a=a[0],b.building=a.value,ga("send","event","Building","Building Selected",b.building.name))},b.dateInit=function(a){$(".date").datepicker({clearBtn:!0,endDate:"+0d",startDate:"-100y"})},b.inputBlur=function(a,c){"ASSET_TAG"==a.name&&(b.tagFocused=!1,b.facilityid=a.value,b.oid=null,j(b.token,a,b.table.id))},b.inputFocus=function(a,c){"ASSET_TAG"==a.name&&(b.tagFocused=!0)},b.clearForm=function(a,c){b.oid=null,d.scrollTo(0,0),angular.forEach(b.fields,function(d){a?d.defaultValue?d.value=d.defaultValue:d.value=null:-1===b.persistedFields.indexOf(d.name)&&(c&&"ASSET_TAG"===d.name?d.value=d.value:d.defaultValue?d.value=d.defaultValue:d.value=null)})},b.resetForm=function(){b.type=null,b.types=null,b.fields=null,b.table=null,b.oid=null,b.alert=null},b.confirm=function(){b.confirmation.modal({keyboard:!1,backdrop:"static"})},b.hideConfirmation=function(){b.confirmation.modal("hide")},b.submitForm=function(){var a={attributes:{}};b.processing=!0,angular.forEach(b.fields,function(c){switch(c.name){case"ASSET_TYPE_SUBTYPE":a.attributes[c.name]=b.type.id;break;case"ASSET_TYPE":a.attributes[c.name]=b.type.name;break;case"SITE":a.attributes[c.name]=b.site.name;break;case"LOCATION":a.attributes[c.name]=b.building.name;break;case"BUILDINGID":a.attributes[c.name]=b.building.id;break;case"LEGACYID":a.attributes[c.name]=b.building.address;break;case"FACILITYID":a.attributes[c.name]=b.facilityid;break;case"LOCATION_TYPE":a.attributes[c.name]=b.building.assetType;break;case"FO_ASSET_ID":a.attributes[c.name]=b.building.id;break;case"FO_ASSETID":a.attributes[c.name]=b.building.id;break;default:if(c.value){if(a.attributes[c.name]=c.value,""===c.value&&(a.attributes[c.name]=null),!c.domain&&"string"==typeof c.value&&(a.attributes[c.name]=c.value.toUpperCase(),"esriFieldTypeDate"===c.type)){var d=moment(c.value);c.value=1e3*d.unix(),a.attributes[c.name]=c.value}}else a.attributes[c.name]=null}}),b.oid&&(a.attributes.OBJECTID=b.oid),b.feature=a,l(b.token,a,b.table.id,b.oid)}}],link:function(a,b,c,d){a.hiddenFields=c.hiddenFields.split(","),a.persistedFields=c.persistedFields.split(","),a.confirmation=$("#confirmModal",b[0]),$(document).on("keydown",function(a){8!==a.which||$(a.target).is("input, textarea")||a.preventDefault()})}}}]).factory("assets",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"POST",url:i,data:$.param({token:c,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d.resolve).error(d.resolve),d.promise}function d(c,d){var e=b.defer();return a({method:"POST",url:i+"/"+d,data:$.param({token:c,f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(e.resolve).error(e.resolve),e.promise}function e(c){var d=b.defer();return a({method:"POST",url:i+"/0/query",data:$.param({token:c,where:"EXISTING = 'Yes' and LOCATION IS NOT NULL",returnGeometry:!1,outFields:"*",orderByFields:"SITE, LOCATION",f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(d.resolve).error(d.resolve),d.promise}function f(c,d,e){var f=b.defer();return a({method:"POST",url:i+"/"+e+"/query",data:$.param({token:c,where:"FACILITYID = '"+d+"'",returnGeometry:!1,outFields:"*",f:"json"}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(f.resolve).error(f.resolve),f.promise}function g(c,d,e,f){var g=b.defer();return a({method:"POST",url:i+"/"+e+"/"+(f?"updateFeatures":"addFeatures"),params:{token:c,features:JSON.stringify([d]),f:"json"}}).success(g.resolve).error(g.resolve),g.promise}var h={getTables:c,getTypes:d,getSites:e,checkAssetExists:f,submitAsset:g},i="https://maps.raleighnc.gov/arcgis/rest/services/Parks/AssetForm/FeatureServer";return h}]);